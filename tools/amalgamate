#!/usr/bin/env python2.7
## -*- mode: python -*-
import sys
import re
from os import path

included_files =  []

def process_file(filename):
    if filename in included_files:
        return
    included_files.append(filename)
    fd = open(filename)
    line_number = 1
    print "#line %i \"%s\"" % (line_number, filename)
    for line in fd.readlines():
        clean = line.rstrip()
        ## Is this an include statement?
        matches = re.match("#include \"(.*)\"", clean)
        if matches:
            include_file = path.join(path.dirname(filename), matches.group(1))
            ## Has this file not been included previously?
            if not include_file in included_files:
                process_file(include_file)
                print "#line %i \"%s\"" % (line_number + 1, filename)
        else:
            print clean
        line_number = line_number + 1
    fd.close()

filenames = sys.argv[1:]

print """

/************************************************************************
 * WARNING
 *
 * This file is an auto-generated amalgamation. Any changes made to this
 * file will be lost when it is regenerated!
 ************************************************************************/

"""
for filename in filenames:
    process_file(filename)
